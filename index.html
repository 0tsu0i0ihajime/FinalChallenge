<html>
<head>
  <meta charset="UTF-8">
  <link rel="manifest" href="./manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('js/serviceworker.js').then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }).catch(function(err) {
            console.log('ServiceWorker registration failed: ', err);
        });
    }    
    </script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="./VueQrcodeReader.umd.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://unpkg.com/dexie@latest/dist/dexie.min.js"></script>
  <script>
    var db = new Dexie("VisitorsDataBase");
    db.version(1).stores({
      Visitors: "id, class, name, place"
    });
    function bulkPutData(){
      db.Visitors
        .bulkPut([
          {id:"D4A65B7E-2BBA-435E-A676-B3CE9517E926", class:"3E11", name:"加藤滉大", place:"203"},
          {id:"DA66VZC4-14RA-UCI8-LEO2-AJVJXOA3578V", class:"2C11", name:"金子巧磨", place:"2C"},
          {id:"5AG4644B-4SGE-JSIS-2Z2BEG5AFGE4GS4G4", class:"2C08", name:"長田賢幸", place:"104"}
        ])
        .catch((error)=>{
          console.error(error);
        });
    }
    function getData(data){
      db.Visitors.get(data)
        .then((visitor)=>{
          console.log(visitor.place);
          alert(visitor.place);
          // return visitor.place もろもろの結果を考えるにここが上手くいっていない
        })
        .catch((error)=>{
          console.error(error);
          return false
        });
    }
    function deleteData(){
      db.delete()
        .then(()=>{
          console.log('Database successfully deleted');
        })
        .catch((error)=>{
          console.error(error);
        })
    }
  </script>
  <title>Final</title>
</head>
<body>
  <style>
    body {
      position: fixed;
      margin:0;
    }
    .fullscreen{
        position: fixed;
        top:0;
        left:0;
        width:100%;
        height:100%;
        background:rgb(0, 0, 0);
        text-align:center;
        vertical-align:bottom;
        margin:0;
    }
    .normal{
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        max-width: 80%;
        max-height: 80%;
        margin: auto; 
    }
    .AddData{
      position: absolute;top:0px;right: 20px;z-index: 100;
    }
    .AddData div{
      position: absolute;top: 30px;z-index: 10;
    }
  </style>
  <div id="app">
    <p class="error">{{error}}</p>
    <div v-if="!FullscreenChange">
    <p class="decode-result">Last result: <b>{{result}}</b><br>
    Last answer: <b>{{answer}}</b></p>
    <div class="AddData">
    <button type="button" @click="bulkPutData">DBData追加</button>
    <div class="deleteData">
    <button class="deleteData" type="button" @click="deleteData">DBData削除</button>
    </div>
    </div>
    <button style="position: fixed;bottom:20px;right: 20px;z-index: 1000;" type="button" @click="onFullChange">全画面に変更</button>
    </div>
    <div v-if="FullscreenChange">
      <button style="position:fixed;bottom:20px;right:20px;z-index:1000;" type="button" @click="onDefaultChange">全画面を終了</button>
    </div>
    <div v-if="pause">
      GooD!
    </div>
    <qrcode-stream @decode="onDecode" @init="onInit" class="fullscreen" id="Change"/>
  </div>
  <script>
    const QrcodeStream = window.VueQrcodeReader.QrcodeStream;
    new Vue({
      el:'#app',
      components:{
        'qrcode-stream':QrcodeStream,
      },
      data:{
        result:'',
        error:'',
        answer:'',
        pause:false,
        FullscreenChange:true
      },
      methods:{
        async onInit(promise){
          try{
            await promise
          }catch(error){
        if (error.name === 'NotAllowedError') {
          this.error = "ERROR: you need to grant camera access permisson"
        } else if (error.name === 'NotFoundError') {
          this.error = "ERROR: no camera on this device"
        } else if (error.name === 'NotSupportedError') {
          this.error = "ERROR: secure context required (HTTPS, localhost)"
        } else if (error.name === 'NotReadableError') {
          this.error = "ERROR: is the camera already in use?"
        } else if (error.name === 'OverconstrainedError') {
          this.error = "ERROR: installed cameras are not suitable"
        } else if (error.name === 'StreamApiNotSupportedError') {
          this.error = "ERROR: Stream API is not supported in this browser"
        }
      }
    },
        onDecode(result){
          this.result=result;
          this.answer = getData(result);
          console.log(this.answer)
        },
        onFullChange(){
          $("#Change").toggleClass("normal","fullscreen");
          this.FullscreenChange = true;
        },
        onDefaultChange(){
          $("#Change").toggleClass("normal","fullscreen");
          this.FullscreenChange=false;
        }
   }
  })
  </script>
</body>
</html>
