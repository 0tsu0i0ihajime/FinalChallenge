<html>
<head>
  <meta charset="UTF-8">
  <link rel="manifest" href="./manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('js/serviceworker.js').then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }).catch(function(err) {
            console.log('ServiceWorker registration failed: ', err);
        });
    }    
    </script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="./VueQrcodeReader.umd.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script type="text/javascript">
    var dbName = "VisitorData"
    var verNo = 1;
    var objStoreName = "Visitor";
    var db;
    var openReq = indexedDB.open(dbName,verNo);
    function openDB(){
      var dbName = "VisitorData"
      var verNo = 1;
      var objStoreName = "Visitor";
      var db;
      var openReq = indexedDB.open(dbName,verNo);
      openReq.onupgradeneeded = function(event){
        db = openReq.result;
        db.onerror = function(event){
          console.error('DBの作成に失敗しました')
        };
        if(!db.objectStoreNames.contains(objStoreName)){
          var objStoreKey = { keyPath: 'id' };
          var obj = db.createObjectStore(objStoreName, objStoreKey);
          console.log('オブジェクトストア生成成功');
        }
      };
      openReq.onsuccess = function(event){
        db = openReq.result;
        console.log('DBOpen成功')
      }
      openReq.onerror = function(event){
        console.error('DBOpen失敗')
      }
    }
    function addData(){
      db = openReq.result;
      var transaction = db.transaction("Visitor", "readwrite");
      var objectStore = transaction.objectStore(objStoreName);
      var data = { id: 'D4A65B7E-2BBA-435E-A676-B3CE9517E926', data1:'abcde',data2:'123',data3:{data3_1:'001',data3_2:1000}};
      // { id: 'DA4FDSDF-FAS4-44AT-ADV1-F4531X15EG13', data1:'AH',data2:'456',data3:{data3_1:'132',data3_2:100}}
      var request = objectStore.add(data);
      request.onsuccess = function(event){
        console.log('保存成功');
      };request.onerror = function(event){
        console.error('保存失敗。 event:',event);
      };
    }
  </script>
  <title>Final</title>
</head>
<body>
  <style>
    body {
      margin:0;
    }
    .fullscreen{
        position: fixed;
        top:0;
        left:0;
        width:100%;
        height:100%;
        background:rgb(0, 0, 0);
        text-align:center;
        vertical-align:bottom;
        margin:0;
    }
    .normal{
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        max-width: 80%;
        max-height: 80%;
        margin: auto; 
    }
    .AddData{
      position: absolute;bottom:0px;left: 20px;z-index: 100;
    }
    .AddData div{
      position: absolute;bottom: 30px;z-index: 10;
    }
  </style>
  <div id="app">
    <p class="error">{{error}}</p>
    <div v-if="!FullscreenChange">
    <p class="decode-result">Last result: <b>{{result}}</b></p>
    <div class="AddData">
    <button type="button" @click="addData">DBData追加</button>
    <div class="Data">
    <button class="Data" type="button"@click="openDB">DBを開く</button>
    </div>
    </div>
    <button style="position: fixed;bottom:20px;right: 20px;z-index: 1000;" type="button" @click="onFullChange">全画面に変更</button>
    </div>
    <div v-if="FullscreenChange">
      <button style="position:fixed;bottom:20px;right:20px;z-index:1000;" type="button" @click="onDefaultChange">全画面を終了</button>
    </div>
    <qrcode-stream @decode="onDecode" @init="onInit" class="fullscreen" id="Change"/>
  </div>
  <script>
    const QrcodeStream = window.VueQrcodeReader.QrcodeStream;
    new Vue({
      el:'#app',
      components:{
        'qrcode-stream':QrcodeStream,
      },
      data:{
        result:'',
        error:'',
        FullscreenChange:true
      },
      methods:{
        async onInit(promise){
          try{
            await promise
          }catch(error){
        if (error.name === 'NotAllowedError') {
          this.error = "ERROR: you need to grant camera access permisson"
        } else if (error.name === 'NotFoundError') {
          this.error = "ERROR: no camera on this device"
        } else if (error.name === 'NotSupportedError') {
          this.error = "ERROR: secure context required (HTTPS, localhost)"
        } else if (error.name === 'NotReadableError') {
          this.error = "ERROR: is the camera already in use?"
        } else if (error.name === 'OverconstrainedError') {
          this.error = "ERROR: installed cameras are not suitable"
        } else if (error.name === 'StreamApiNotSupportedError') {
          this.error = "ERROR: Stream API is not supported in this browser"
        }
      }
    },
        onDecode(result){
          this.result=result
        },
        onFullChange(){
          $("#Change").toggleClass("normal","fullscreen");
          this.FullscreenChange = true;
        },
        onDefaultChange(){
          $("#Change").toggleClass("normal","fullscreen");
          this.FullscreenChange=false;
        }
   }
  })
  </script>
</body>
</html>
